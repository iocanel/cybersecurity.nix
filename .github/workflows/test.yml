name: Test Cybersecurity Module

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  test-packages:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
    
    - name: Install Nix
      uses: cachix/install-nix-action@v25
      with:
        nix_path: nixpkgs=channel:nixos-25.05
    
    - name: Test custom package builds
      run: |
        nix-build -E 'with import <nixpkgs> {}; callPackage ./packages/deepce.nix {}'
        nix-build -E 'with import <nixpkgs> {}; callPackage ./packages/droopescan.nix {}'
    
    - name: Test module syntax (system)
      run: |
        nix-instantiate --eval -E '
          let
            pkgs = import <nixpkgs> {};
            lib = pkgs.lib;
            module = import ./system.nix { inherit lib; config = { cybersecurity.enable = true; }; inherit pkgs; };
          in
          builtins.hasAttr "options" module && builtins.hasAttr "config" module
        '
    
    - name: Test module syntax (home)
      run: |
        nix-instantiate --eval -E '
          let
            pkgs = import <nixpkgs> {};
            lib = pkgs.lib;
            module = import ./home.nix { inherit lib; config = { cybersecurity.enable = true; home.homeDirectory = "/tmp"; }; inherit pkgs; };
          in
          builtins.hasAttr "options" module && builtins.hasAttr "config" module
        '

  test-package-categories:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
    
    - name: Install Nix
      uses: cachix/install-nix-action@v25
      with:
        nix_path: nixpkgs=channel:nixos-25.05
    
    - name: Test package categories build
      run: |
        nix-instantiate --eval -E '
          let
            pkgs = import <nixpkgs> {};
            packages = import ./packages.nix { inherit pkgs; };
          in
          {
            coreToolsLength = builtins.length packages.coreTools;
            systemToolsLength = builtins.length packages.systemTools;
            customPackages = {
              deepce = packages.deepce.name;
              droopescan = packages.droopescan.name;
              burpsuite = packages.burpsuite.name;
            };
          }
        '

  test-nixos-integration:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
    
    - name: Install Nix
      uses: cachix/install-nix-action@v25
      with:
        nix_path: nixpkgs=channel:nixos-25.05
    
    - name: Test NixOS module evaluation
      run: |
        # Test that the system module can be evaluated with a minimal NixOS configuration
        nix-instantiate --eval -E '
          let
            pkgs = import <nixpkgs> {};
            lib = pkgs.lib;
            nixosModules = import <nixpkgs/nixos/modules/module-list.nix>;
            result = lib.evalModules {
              modules = nixosModules ++ [ 
                ./system.nix
                {
                  cybersecurity.enable = true;
                  networking.hostName = "test";
                  users.users.test.isNormalUser = true;
                  system.stateVersion = "25.05";
                  fileSystems."/".device = "/dev/null";
                }
              ];
              specialArgs = { inherit pkgs; };
            };
          in
          builtins.length result.config.environment.systemPackages > 0
        '

  test-home-manager-integration:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
    
    - name: Install Nix
      uses: cachix/install-nix-action@v25
      with:
        nix_path: nixpkgs=channel:nixos-25.05
        extra_nix_config: |
          experimental-features = nix-command flakes
    
    - name: Test Home Manager compatibility
      run: |
        # Test that home.nix can be imported and evaluated standalone
        nix-instantiate --eval -E '
          let
            pkgs = import <nixpkgs> {};
            lib = pkgs.lib;
            # Test basic module structure and package list generation
            module = import ./home.nix { inherit lib; config = { cybersecurity.enable = true; home.homeDirectory = "/home/test"; }; inherit pkgs; };
            packages = import ./packages.nix { inherit pkgs; };
          in
          {
            hasOptions = builtins.hasAttr "options" module;
            hasConfig = builtins.hasAttr "config" module;
            coreToolsCount = builtins.length packages.coreTools;
            systemToolsCount = builtins.length packages.systemTools;
          }
        '

  test-tool-availability:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
    
    - name: Install Nix
      uses: cachix/install-nix-action@v25
      with:
        nix_path: nixpkgs=channel:nixos-25.05
    
    - name: Build environment with cybersecurity tools
      run: |
        # Create a test environment with all cybersecurity tools
        nix-build -E '
          let
            pkgs = import <nixpkgs> { config.allowUnfree = true; };
            cybersecPackages = import ./packages.nix { inherit pkgs; };
            allTools = cybersecPackages.coreTools ++ cybersecPackages.systemTools ++ [
              cybersecPackages.deepce
              cybersecPackages.droopescan  
              cybersecPackages.burpsuite
            ];
          in
          pkgs.buildEnv {
            name = "cybersec-test-env";
            paths = allTools;
            ignoreCollisions = true;
          }
        '
    
    - name: Test popular tools are available
      run: |
        # Test that popular security tools have working binaries
        TEST_ENV=$(nix-build -E '
          let
            pkgs = import <nixpkgs> { config.allowUnfree = true; };
            cybersecPackages = import ./packages.nix { inherit pkgs; };
            allTools = cybersecPackages.coreTools ++ cybersecPackages.systemTools ++ [
              cybersecPackages.deepce
              cybersecPackages.droopescan  
              cybersecPackages.burpsuite
            ];
          in
          pkgs.buildEnv {
            name = "cybersec-test-env";
            paths = allTools;
            ignoreCollisions = true;
          }
        ')
        
        # Test popular tools
        echo "Testing tool availability..."
        
        # Network tools
        test -x "$TEST_ENV/bin/nmap" && echo "✓ nmap available"
        test -x "$TEST_ENV/bin/masscan" && echo "✓ masscan available"
        test -x "$TEST_ENV/bin/rustscan" && echo "✓ rustscan available"
        
        # Web security
        test -x "$TEST_ENV/bin/sqlmap" && echo "✓ sqlmap available"
        test -x "$TEST_ENV/bin/nikto" && echo "✓ nikto available"
        test -x "$TEST_ENV/bin/nuclei" && echo "✓ nuclei available"
        test -x "$TEST_ENV/bin/burpsuite" && echo "✓ burpsuite available"
        
        # Password tools  
        test -x "$TEST_ENV/bin/john" && echo "✓ john available"
        test -x "$TEST_ENV/bin/hashcat" && echo "✓ hashcat available"
        test -x "$TEST_ENV/bin/hydra" && echo "✓ hydra available"
        
        # Wireless
        test -x "$TEST_ENV/bin/aircrack-ng" && echo "✓ aircrack-ng available"
        
        # Exploitation
        test -x "$TEST_ENV/bin/msfconsole" && echo "✓ metasploit available"
        
        # OSINT
        test -x "$TEST_ENV/bin/theharvester" && echo "✓ theharvester available"
        test -x "$TEST_ENV/bin/amass" && echo "✓ amass available"
        
        # Custom packages
        test -x "$TEST_ENV/bin/deepce" && echo "✓ deepce available"
        test -x "$TEST_ENV/bin/droopescan" && echo "✓ droopescan available"
        
        echo "All popular security tools verified!"

  test-module-tool-availability:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        module:
          - name: "NixOS system"
            file: "system.nix"
            config_key: "environment.systemPackages"
            test_config: '{ cybersecurity.enable = true; }'
          - name: "Home Manager"
            file: "home.nix"  
            config_key: "home.packages"
            test_config: '{ cybersecurity.enable = true; home.homeDirectory = "/home/test"; }'
    
    name: "Test ${{ matrix.module.name }} module tool availability"
    steps:
    - uses: actions/checkout@v4
    
    - name: Install Nix
      uses: cachix/install-nix-action@v25
      with:
        nix_path: nixpkgs=channel:nixos-25.05
    
    - name: Test ${{ matrix.module.name }} module tool availability
      run: |
        # Test that tools are available in ${{ matrix.module.name }} module
        nix-instantiate --eval -E '
          let
            pkgs = import <nixpkgs> { config.allowUnfree = true; };
            lib = pkgs.lib;
            module = import ./${{ matrix.module.file }} { inherit lib; config = ${{ matrix.module.test_config }}; inherit pkgs; };
            packages = module.config.${{ matrix.module.config_key }};
            toolNames = map (pkg: pkg.pname or pkg.name or "unknown") packages;
          in
          {
            packageCount = builtins.length packages;
            hasNmap = builtins.any (name: lib.hasInfix "nmap" name) toolNames;
            hasMetasploit = builtins.any (name: lib.hasInfix "metasploit" name) toolNames;
            hasSqlmap = builtins.any (name: lib.hasInfix "sqlmap" name) toolNames;
            hasJohn = builtins.any (name: lib.hasInfix "john" name) toolNames;
            hasHashcat = builtins.any (name: lib.hasInfix "hashcat" name) toolNames;
            hasWireshark = builtins.any (name: lib.hasInfix "wireshark" name) toolNames;
            hasAircrack = builtins.any (name: lib.hasInfix "aircrack" name) toolNames;
            hasDeepce = builtins.any (name: lib.hasInfix "deepce" name) toolNames;
            hasDroopescan = builtins.any (name: lib.hasInfix "droopescan" name) toolNames;
            hasBurpsuite = builtins.any (name: lib.hasInfix "burpsuite" name) toolNames;
          }
        ' | grep -E "(hasNmap|hasMetasploit|hasSqlmap|hasJohn|hasHashcat|hasWireshark|hasAircrack|hasDeepce|hasDroopescan|hasBurpsuite)" | grep -v "false" && echo "✓ All key tools found in ${{ matrix.module.name }} packages" || echo "✗ Some tools missing in ${{ matrix.module.name }}"