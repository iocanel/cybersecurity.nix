name: Test Cybersecurity Module

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  test-packages:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
    
    - name: Install Nix
      uses: cachix/install-nix-action@v25
      with:
        nix_path: nixpkgs=channel:nixos-25.05
    
    - name: Test custom package builds
      run: |
        nix-build -E 'with import <nixpkgs> {}; callPackage ./packages/deepce.nix {}'
        nix-build -E 'with import <nixpkgs> {}; callPackage ./packages/droopescan.nix {}'
    
    - name: Test module syntax (system)
      run: |
        nix-instantiate --eval -E '
          let
            pkgs = import <nixpkgs> {};
            lib = pkgs.lib;
            module = import ./system.nix { inherit lib; config = { cybersecurity.enable = true; }; inherit pkgs; };
          in
          builtins.hasAttr "options" module && builtins.hasAttr "config" module
        '
    
    - name: Test module syntax (home)
      run: |
        nix-instantiate --eval -E '
          let
            pkgs = import <nixpkgs> {};
            lib = pkgs.lib;
            module = import ./home.nix { inherit lib; config = { cybersecurity.enable = true; home.homeDirectory = "/tmp"; }; inherit pkgs; };
          in
          builtins.hasAttr "options" module && builtins.hasAttr "config" module
        '

  test-package-categories:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
    
    - name: Install Nix
      uses: cachix/install-nix-action@v25
      with:
        nix_path: nixpkgs=channel:nixos-25.05
    
    - name: Test package categories build
      run: |
        nix-instantiate --eval -E '
          let
            pkgs = import <nixpkgs> {};
            packages = import ./packages.nix { inherit pkgs; };
          in
          {
            coreToolsLength = builtins.length packages.coreTools;
            systemToolsLength = builtins.length packages.systemTools;
            customPackages = {
              deepce = packages.deepce.name;
              droopescan = packages.droopescan.name;
              burpsuite = packages.burpsuite.name;
            };
          }
        '

  test-nixos-integration:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
    
    - name: Install Nix
      uses: cachix/install-nix-action@v25
      with:
        nix_path: nixpkgs=channel:nixos-25.05
    
    - name: Test NixOS module evaluation
      run: |
        # Test that the system module can be evaluated with a minimal NixOS configuration
        nix-instantiate --eval -E '
          let
            pkgs = import <nixpkgs> {};
            lib = pkgs.lib;
            nixosModules = import <nixpkgs/nixos/modules/module-list.nix>;
            result = lib.evalModules {
              modules = nixosModules ++ [ 
                ./system.nix
                {
                  cybersecurity.enable = true;
                  networking.hostName = "test";
                  users.users.test.isNormalUser = true;
                  system.stateVersion = "25.05";
                  fileSystems."/".device = "/dev/null";
                }
              ];
              specialArgs = { inherit pkgs; };
            };
          in
          builtins.length result.config.environment.systemPackages > 0
        '

  test-home-manager-integration:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
    
    - name: Install Nix
      uses: cachix/install-nix-action@v25
      with:
        nix_path: nixpkgs=channel:nixos-25.05
        extra_nix_config: |
          experimental-features = nix-command flakes
    
    - name: Test Home Manager compatibility
      run: |
        # Test that home.nix can be imported and evaluated standalone
        nix-instantiate --eval -E '
          let
            pkgs = import <nixpkgs> {};
            lib = pkgs.lib;
            # Test basic module structure and package list generation
            module = import ./home.nix { inherit lib; config = { cybersecurity.enable = true; home.homeDirectory = "/home/test"; }; inherit pkgs; };
            packages = import ./packages.nix { inherit pkgs; };
          in
          {
            hasOptions = builtins.hasAttr "options" module;
            hasConfig = builtins.hasAttr "config" module;
            coreToolsCount = builtins.length packages.coreTools;
            systemToolsCount = builtins.length packages.systemTools;
          }
        '