name: Test Cybersecurity Module

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  test-packages:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
    
    - name: Install Nix
      uses: cachix/install-nix-action@v25
      with:
        nix_path: nixpkgs=channel:nixos-25.05
    
    - name: Test custom package builds
      run: |
        nix-build -E 'with import <nixpkgs> {}; callPackage ./packages/deepce.nix {}'
        nix-build -E 'with import <nixpkgs> {}; callPackage ./packages/droopescan.nix {}'
    
    - name: Test module syntax (system)
      run: |
        nix-instantiate --eval -E '
          let
            pkgs = import <nixpkgs> {};
            lib = pkgs.lib;
            module = import ./system.nix { inherit lib; config = { cybersecurity.enable = true; }; inherit pkgs; };
          in
          builtins.hasAttr "options" module && builtins.hasAttr "config" module
        '
    
    - name: Test module syntax (home)
      run: |
        nix-instantiate --eval -E '
          let
            pkgs = import <nixpkgs> {};
            lib = pkgs.lib;
            module = import ./home.nix { inherit lib; config = { cybersecurity.enable = true; home.homeDirectory = "/tmp"; }; inherit pkgs; };
          in
          builtins.hasAttr "options" module && builtins.hasAttr "config" module
        '

  test-package-categories:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
    
    - name: Install Nix
      uses: cachix/install-nix-action@v25
      with:
        nix_path: nixpkgs=channel:nixos-25.05
    
    - name: Test package categories build
      run: |
        nix-instantiate --eval -E '
          let
            pkgs = import <nixpkgs> {};
            packages = import ./packages.nix { inherit pkgs; };
          in
          {
            coreToolsLength = builtins.length packages.coreTools;
            systemToolsLength = builtins.length packages.systemTools;
            customPackages = {
              deepce = packages.deepce.name;
              droopescan = packages.droopescan.name;
              burpsuite = packages.burpsuite.name;
            };
          }
        '

  test-nixos-integration:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
    
    - name: Install Nix
      uses: cachix/install-nix-action@v25
      with:
        nix_path: nixpkgs=channel:nixos-25.05
    
    - name: Test NixOS module evaluation
      run: |
        # Test that the system module can be evaluated with a minimal NixOS configuration
        nix-instantiate --eval -E '
          let
            pkgs = import <nixpkgs> {};
            lib = pkgs.lib;
            nixosModules = import <nixpkgs/nixos/modules/module-list.nix>;
            result = lib.evalModules {
              modules = nixosModules ++ [ 
                ./system.nix
                {
                  cybersecurity.enable = true;
                  networking.hostName = "test";
                  users.users.test.isNormalUser = true;
                  system.stateVersion = "25.05";
                  fileSystems."/".device = "/dev/null";
                }
              ];
              specialArgs = { inherit pkgs; };
            };
          in
          builtins.length result.config.environment.systemPackages > 0
        '

  test-home-manager-integration:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
    
    - name: Install Nix
      uses: cachix/install-nix-action@v25
      with:
        nix_path: nixpkgs=channel:nixos-25.05
        extra_nix_config: |
          experimental-features = nix-command flakes
    
    - name: Test Home Manager compatibility
      run: |
        # Test that home.nix can be imported and evaluated standalone
        nix-instantiate --eval -E '
          let
            pkgs = import <nixpkgs> {};
            lib = pkgs.lib;
            # Test basic module structure and package list generation
            module = import ./home.nix { inherit lib; config = { cybersecurity.enable = true; home.homeDirectory = "/home/test"; }; inherit pkgs; };
            packages = import ./packages.nix { inherit pkgs; };
          in
          {
            hasOptions = builtins.hasAttr "options" module;
            hasConfig = builtins.hasAttr "config" module;
            coreToolsCount = builtins.length packages.coreTools;
            systemToolsCount = builtins.length packages.systemTools;
          }
        '


  test-nixos-realistic:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
    
    - name: Install Nix
      uses: cachix/install-nix-action@v25
      with:
        nix_path: nixpkgs=channel:nixos-25.05
    
    - name: Build NixOS system packages with cybersecurity module
      run: |
        # Simulate: Extract system packages that nixos-rebuild switch would install
        echo "Building NixOS system packages with cybersecurity module..."
        SYSTEM_ENV=$(nix-build -E '
          let
            pkgs = import <nixpkgs> { config.allowUnfree = true; };
            cybersecPackages = import ./packages.nix { inherit pkgs; };
            # Build the same packages that system.nix would provide
            allTools = cybersecPackages.coreTools ++ cybersecPackages.systemTools ++ [
              cybersecPackages.deepce
              cybersecPackages.droopescan  
              cybersecPackages.burpsuite
            ];
          in
          pkgs.buildEnv {
            name = "nixos-cybersec-env";
            paths = allTools;
            ignoreCollisions = true;
          }
        ')
        echo "NixOS packages built at: $SYSTEM_ENV"
        echo "SYSTEM_ENV=$SYSTEM_ENV" >> $GITHUB_ENV
    
    - name: Test system PATH contains security tools
      run: |
        # Test that popular security tools are available in system PATH
        echo "Testing security tools in NixOS system PATH..."
        
        # Test network tools
        test -x "$SYSTEM_ENV/bin/nmap" && echo "✓ nmap available in NixOS system packages"
        test -x "$SYSTEM_ENV/bin/masscan" && echo "✓ masscan available in NixOS system packages"
        test -x "$SYSTEM_ENV/bin/rustscan" && echo "✓ rustscan available in NixOS system packages"
        
        # Test web security
        test -x "$SYSTEM_ENV/bin/sqlmap" && echo "✓ sqlmap available in NixOS system packages"
        test -x "$SYSTEM_ENV/bin/nikto" && echo "✓ nikto available in NixOS system packages"
        test -x "$SYSTEM_ENV/bin/nuclei" && echo "✓ nuclei available in NixOS system packages"
        
        # Test password tools
        test -x "$SYSTEM_ENV/bin/john" && echo "✓ john available in NixOS system packages"
        test -x "$SYSTEM_ENV/bin/hashcat" && echo "✓ hashcat available in NixOS system packages"
        test -x "$SYSTEM_ENV/bin/hydra" && echo "✓ hydra available in NixOS system packages"
        
        # Test exploitation
        test -x "$SYSTEM_ENV/bin/msfconsole" && echo "✓ metasploit available in NixOS system packages"
        
        # Test custom packages
        test -x "$SYSTEM_ENV/bin/deepce" && echo "✓ deepce available in NixOS system packages"
        test -x "$SYSTEM_ENV/bin/droopescan" && echo "✓ droopescan available in NixOS system packages"
        
        echo "✓ NixOS system simulation completed successfully"
    
    - name: Test NixOS system-specific features
      run: |
        # Test system-specific features that NixOS module provides
        echo "Testing NixOS system-specific features..."
        
        # Test that system.nix module has valid structure 
        nix-instantiate --eval -E '
          let
            pkgs = import <nixpkgs> { config.allowUnfree = true; };
            lib = pkgs.lib;
            systemModule = import ./system.nix { inherit lib; config = { cybersecurity.enable = true; }; inherit pkgs; };
          in
          builtins.hasAttr "options" systemModule && builtins.hasAttr "config" systemModule
        ' | grep -q "true" && echo "✓ NixOS module structure valid"
        
        # Test that system.nix includes system packages when enabled
        nix-instantiate --eval -E '
          let
            pkgs = import <nixpkgs> { config.allowUnfree = true; };
            lib = pkgs.lib;
            systemModule = import ./system.nix { inherit lib; config = { cybersecurity.enable = true; }; inherit pkgs; };
          in
          builtins.length systemModule.config.environment.systemPackages > 50
        ' | grep -q "true" && echo "✓ NixOS system configures security packages when enabled"
        
        # Test that system.nix defines cybersecurity option
        nix-instantiate --eval -E '
          let
            pkgs = import <nixpkgs> { config.allowUnfree = true; };
            lib = pkgs.lib;
            systemModule = import ./system.nix { inherit lib; config = {}; inherit pkgs; };
          in
          builtins.hasAttr "cybersecurity" systemModule.options
        ' | grep -q "true" && echo "✓ NixOS module defines cybersecurity option"
        
        echo "✓ NixOS system features testing completed"

  test-home-manager-realistic:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
    
    - name: Install Nix
      uses: cachix/install-nix-action@v25
      with:
        nix_path: nixpkgs=channel:nixos-25.05
    
    - name: Build Home Manager environment with cybersecurity module
      run: |
        # Simulate: home-manager switch with cybersecurity.enable = true
        echo "Building Home Manager environment with cybersecurity module..."
        USER_ENV=$(nix-build -E '
          let
            pkgs = import <nixpkgs> { config.allowUnfree = true; };
            cybersecPackages = import ./packages.nix { inherit pkgs; };
            # Directly build the same packages that home.nix would provide
            allTools = cybersecPackages.coreTools ++ cybersecPackages.systemTools ++ [
              cybersecPackages.deepce
              cybersecPackages.droopescan  
              cybersecPackages.burpsuite
            ];
          in
          pkgs.buildEnv {
            name = "home-manager-cybersec-env";
            paths = allTools;
            ignoreCollisions = true;
          }
        ')
        echo "Home Manager environment built at: $USER_ENV"
        echo "USER_ENV=$USER_ENV" >> $GITHUB_ENV
    
    - name: Test user environment contains security tools
      run: |
        # Test that popular security tools are available in user environment
        echo "Testing security tools in Home Manager user environment..."
        
        # Test network tools
        test -x "$USER_ENV/bin/nmap" && echo "✓ nmap available in user environment"
        test -x "$USER_ENV/bin/masscan" && echo "✓ masscan available in user environment"
        test -x "$USER_ENV/bin/rustscan" && echo "✓ rustscan available in user environment"
        
        # Test web security
        test -x "$USER_ENV/bin/sqlmap" && echo "✓ sqlmap available in user environment"
        test -x "$USER_ENV/bin/nikto" && echo "✓ nikto available in user environment"
        test -x "$USER_ENV/bin/nuclei" && echo "✓ nuclei available in user environment"
        
        # Test password tools
        test -x "$USER_ENV/bin/john" && echo "✓ john available in user environment"
        test -x "$USER_ENV/bin/hashcat" && echo "✓ hashcat available in user environment"
        test -x "$USER_ENV/bin/hydra" && echo "✓ hydra available in user environment"
        
        # Test exploitation
        test -x "$USER_ENV/bin/msfconsole" && echo "✓ metasploit available in user environment"
        
        # Test custom packages
        test -x "$USER_ENV/bin/deepce" && echo "✓ deepce available in user environment"
        test -x "$USER_ENV/bin/droopescan" && echo "✓ droopescan available in user environment"
        
        echo "✓ Home Manager simulation completed successfully"
    
    - name: Test Home Manager specific features
      run: |
        # Test user-specific features that Home Manager provides
        echo "Testing Home Manager specific features..."
        
        # Test that home.nix module has the expected structure
        nix-instantiate --eval -E '
          let
            pkgs = import <nixpkgs> { config.allowUnfree = true; };
            lib = pkgs.lib;
            homeModule = import ./home.nix { inherit lib; config = { cybersecurity.enable = true; home.homeDirectory = "/home/testuser"; }; inherit pkgs; };
          in
          builtins.hasAttr "options" homeModule && builtins.hasAttr "config" homeModule
        ' | grep -q "true" && echo "✓ Home Manager module structure valid"
        
        # Test that home.nix defines cybersecurity option
        nix-instantiate --eval -E '
          let
            pkgs = import <nixpkgs> { config.allowUnfree = true; };
            lib = pkgs.lib;
            homeModule = import ./home.nix { inherit lib; config = {}; inherit pkgs; };
          in
          builtins.hasAttr "cybersecurity" homeModule.options
        ' | grep -q "true" && echo "✓ Home Manager module defines cybersecurity option"
        
        # Test that home.nix configures packages when enabled
        nix-instantiate --eval -E '
          let
            pkgs = import <nixpkgs> { config.allowUnfree = true; };
            lib = pkgs.lib;
            homeModule = import ./home.nix { inherit lib; config = { cybersecurity.enable = true; home.homeDirectory = "/home/testuser"; }; inherit pkgs; };
          in
          builtins.length homeModule.config.home.packages > 50
        ' | grep -q "true" && echo "✓ Home Manager configures security packages when enabled"
        
        echo "✓ Home Manager feature testing completed"